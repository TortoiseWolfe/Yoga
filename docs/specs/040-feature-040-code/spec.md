# Feature Specification: Code Quality Improvements

**Feature Branch**: `040-feature-040-code`
**Created**: 2025-11-27
**Status**: Draft
**Input**: User description: "Feature 040: Code Quality Improvements - Address critical issues from code review: (1) Remove CSP unsafe-eval directive, (2) Replace 361 console.log statements with structured logging service, (3) Fix as any type assertions in 56 occurrences across service files, (4) Move private env vars from client config, (5) Add proper error handling to replace 11 silent catch blocks"

---

## Definitions & Scope

### Terminology

| Term                             | Definition                                                                                                                           |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| **Production environment**       | `process.env.NODE_ENV === 'production'` or when `NEXT_PUBLIC_VERCEL_ENV === 'production'`                                            |
| **Development environment**      | `process.env.NODE_ENV === 'development'` or when `NEXT_PUBLIC_VERCEL_ENV !== 'production'`                                           |
| **Client bundle**                | The static JavaScript files generated by `pnpm build` in the `out/` directory                                                        |
| **Service files**                | TypeScript files in `src/services/**/*.ts`                                                                                           |
| **Private environment variable** | Any `process.env.*` variable NOT prefixed with `NEXT_PUBLIC_`                                                                        |
| **Silent failure**               | A catch block that: (a) is empty, (b) returns false/null/undefined without logging, or (c) swallows the error without propagating it |
| **Meaningful error message**     | Error text containing: (a) what operation failed, (b) why it failed, (c) relevant identifiers                                        |

### File Scope

| Scope                   | Pattern                                                             | Count           |
| ----------------------- | ------------------------------------------------------------------- | --------------- |
| console.log replacement | `src/**/*.ts`, `src/**/*.tsx` (excluding `*.test.*`, `*.stories.*`) | 361 occurrences |
| as any removal          | `src/services/**/*.ts`                                              | 56 occurrences  |
| Silent catch blocks     | `src/services/**/*.ts`, `src/lib/**/*.ts`                           | 11 occurrences  |

### Private Environment Variables (Complete List)

These variables MUST NOT appear in the client bundle:

- `STRIPE_SECRET_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `PAYPAL_CLIENT_SECRET`
- `RESEND_API_KEY`
- `DATABASE_URL`
- `DIRECT_URL`

### CSP Directive Change

**Before** (`src/app/layout.tsx:93`):

```
script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://*.google-analytics.com
```

**After**:

```
script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://*.google-analytics.com
```

---

## User Scenarios & Testing _(mandatory)_

### User Story 1 - Security Compliance (Priority: P1)

As a security-conscious developer, I need the application to have proper CSP headers and no exposed secrets so that the application is not vulnerable to XSS attacks or credential theft.

**Why this priority**: CSP unsafe-eval and exposed env vars are critical security vulnerabilities that could lead to compromise. Must be fixed immediately.

**Independent Test**: Can be fully tested by running security audit tools and verifying CSP headers in browser DevTools. Delivers immediate security improvement.

**Acceptance Scenarios**:

1. **Given** the application is running, **When** I inspect CSP headers in DevTools, **Then** I see no `unsafe-eval` directive present
2. **Given** the client-side bundle, **When** I search for private API keys, **Then** no Stripe secret keys or service role keys are found
3. **Given** the application needs dynamic functionality, **When** the app loads, **Then** it works correctly without eval() or new Function()

---

### User Story 2 - Structured Logging (Priority: P2)

As a developer maintaining production code, I need a structured logging service so that I can control log levels, filter logs by category, and have consistent log formatting for debugging.

**Why this priority**: 361 console.log statements make debugging difficult and leak information in production. Critical for maintainability and production readiness.

**Independent Test**: Can be fully tested by running the app and verifying logs use the new logger service with proper log levels.

**Acceptance Scenarios**:

1. **Given** the application is running in production, **When** errors occur, **Then** only error-level logs appear (no debug/info logs)
2. **Given** the application is running in development, **When** I debug, **Then** all log levels appear with timestamps and categories
3. **Given** a service file, **When** I check for console.log usage, **Then** all logging uses the structured logger service

---

### User Story 3 - Type Safety (Priority: P2)

As a TypeScript developer, I need proper type definitions instead of `as any` casts so that I get compile-time type checking and IDE support.

**Why this priority**: Type assertions bypass TypeScript's safety checks, leading to runtime errors. Important for code quality and maintainability.

**Independent Test**: Can be fully tested by running `pnpm type-check` and verifying no `as any` assertions exist in service files.

**Acceptance Scenarios**:

1. **Given** the services directory, **When** I search for `as any`, **Then** no occurrences are found
2. **Given** Supabase queries, **When** data is returned, **Then** it is properly typed without casting
3. **Given** external API responses, **When** data is processed, **Then** proper type guards or Zod schemas validate the data

---

### User Story 4 - Error Handling (Priority: P3)

As a user, I need proper error handling so that when something goes wrong, I see meaningful error messages instead of the app silently failing.

**Why this priority**: Silent catch blocks hide errors and make debugging impossible. Important for user experience and debugging.

**Independent Test**: Can be fully tested by triggering error conditions and verifying appropriate error messages appear.

**Acceptance Scenarios**:

1. **Given** an API call fails, **When** the error occurs, **Then** it is logged with context (function name, parameters)
2. **Given** a function encounters an error, **When** it cannot recover, **Then** it throws or returns an error result (not just false/null)
3. **Given** a user-facing operation fails, **When** the error bubbles up, **Then** a user-friendly message is displayed

---

### Edge Cases

- What happens when the logger service itself fails to initialize?
- How does the app handle missing environment variables at startup?
- What happens when type validation fails on external API responses?
- How are errors handled in async functions within useEffect?

## Requirements _(mandatory)_

### Functional Requirements

#### Security (FR-001 to FR-002)

- **FR-001**: System MUST NOT use `unsafe-eval` in Content Security Policy. Specifically, remove `'unsafe-eval'` from the `script-src` directive in `src/app/layout.tsx:93`.
- **FR-002**: System MUST NOT expose private environment variables in client bundles. Complete list: `STRIPE_SECRET_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `PAYPAL_CLIENT_SECRET`, `RESEND_API_KEY`, `DATABASE_URL`, `DIRECT_URL`.

#### Logger Service (FR-003 to FR-004, FR-009 to FR-010)

- **FR-003**: System MUST provide a structured logging service with:
  - Four log levels: `debug` (0), `info` (1), `warn` (2), `error` (3)
  - Configurable minimum level (build-time via environment, not runtime)
  - Category namespacing for grouping related logs
  - Log level behaviors:
    - `debug`: Development debugging info, suppressed in production
    - `info`: General information, suppressed in production
    - `warn`: Warnings that don't prevent operation, always shown
    - `error`: Errors needing attention, always shown

- **FR-004**: System MUST use the logger service instead of console.log in all `src/**/*.ts` and `src/**/*.tsx` files. **Exception**: `*.test.ts`, `*.test.tsx`, and `*.stories.tsx` files MAY use console.log for debugging/documentation.

- **FR-009**: Logger MUST suppress debug/info logs when `process.env.NODE_ENV === 'production'`. Only warn/error level logs appear.

- **FR-010**: Logger MUST include ISO 8601 timestamps (`YYYY-MM-DDTHH:mm:ss.sssZ`) and category prefix in development environment. Format: `[timestamp] [category] LEVEL: message {context}`

- **FR-011**: Logger service MUST follow the 5-file pattern per Constitution §I:
  - `src/lib/logger/index.ts` - Barrel export
  - `src/lib/logger/logger.ts` - Core implementation
  - `src/lib/logger/logger.test.ts` - Unit tests (100% coverage)
  - `src/lib/logger/logger.stories.tsx` - Storybook demo
  - `src/lib/logger/logger.accessibility.test.ts` - Accessibility placeholder (N/A for non-UI)

- **FR-012**: Logger MUST handle edge cases gracefully:
  - Empty/invalid category: Default to `'app'`
  - Circular references in context: Safely serialize with `[Circular]` placeholder
  - Extremely long messages (>10KB): Truncate with `...[truncated]`
  - Console unavailable: No-op without throwing

- **FR-013**: Logger MUST NOT log sensitive data (PII). Context parameters MUST exclude: passwords, tokens, API keys, email addresses, phone numbers.

#### Type Safety (FR-005 to FR-006)

- **FR-005**: System MUST NOT use `as any` type assertions in `src/services/**/*.ts` files. All 56 occurrences must be replaced with proper types.

- **FR-006**: System MUST use proper TypeScript types for:
  - Supabase query results: Use generated types from `src/lib/supabase/types.ts` plus manual messaging extensions
  - External API responses: Use Zod schemas for runtime validation (preferred over type guards for external data)

- **FR-014**: Messaging types (`conversations`, `messages`, `user_connections`) MUST be defined in `src/lib/supabase/messaging-types.ts` with full Insert/Update/Row shapes per data-model.md §3.

#### Error Handling (FR-007 to FR-008)

- **FR-007**: System MUST provide meaningful error messages in catch blocks. A meaningful error message MUST include:
  - (a) What operation failed (e.g., "Failed to fetch user profile")
  - (b) Why it failed (original error message)
  - (c) Relevant identifiers (userId, conversationId, etc.)
  - **Example**: `"Failed to send message: Network timeout [conversationId=abc123, userId=xyz789]"`

- **FR-008**: System MUST log errors with context including:
  - Function name (e.g., `sendMessage`)
  - Operation description (e.g., "encrypting message content")
  - Relevant parameters (excluding sensitive data)
  - **Example**: `logger.error('sendMessage failed', { conversationId: 'abc', step: 'encryption', error: err.message })`

- **FR-015**: All service functions returning potentially-failed results MUST use `ServiceResult<T>` pattern:
  - Success: `{ data: T, error: null }`
  - Failure: `{ data: null, error: Error }`
  - **Decision**: Return error result (not rethrow) for recoverable errors at service boundaries

- **FR-016**: User-facing error messages MUST be:
  - Non-technical (no stack traces, no internal IDs)
  - Actionable when possible (e.g., "Please try again" or "Check your connection")
  - Logged internally with full technical details before display

### Key Entities

- **Logger Service**: Custom lightweight zero-dependency logging utility with log levels, categories, and environment-aware output (target ~50-100 LOC as guidance, not hard constraint; actual size may vary based on edge case handling)
- **Type Definitions**: Proper interfaces for Supabase responses and external API data (see data-model.md §3)
- **ServiceResult<T>**: Supabase-style `{ data: T, error: null } | { data: null, error: Error }` discriminated union for service functions (see contracts/result.ts)

## Clarifications

### Session 2025-11-27

- Q: Which approach should the logger service use? → A: Custom lightweight (zero dependencies, minimal wrapper around console methods with log levels)
- Q: Which error handling pattern should service functions use? → A: Result tuple - Supabase-style `{ data, error }` objects
- Q: Which scope should the logging replacement cover? → A: All src - Replace all console.log across entire `src/` directory

## Success Criteria _(mandatory)_

### Measurable Outcomes

| ID         | Criterion                           | Verification Command                                                                                                                                                 | Expected Result                                           |
| ---------- | ----------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------- |
| **SC-001** | Zero `unsafe-eval` in CSP           | `grep -r "unsafe-eval" src/app/layout.tsx`                                                                                                                           | No matches                                                |
| **SC-002** | Zero private keys in bundle         | `grep -rE "STRIPE_SECRET\|SERVICE_ROLE\|PAYPAL.*SECRET\|RESEND_API" out/`                                                                                            | No matches                                                |
| **SC-003** | Zero console.log in production code | `grep -r "console\.\(log\|warn\|error\|debug\|info\)" src/ --include="*.ts" --include="*.tsx" \| grep -v "\.test\." \| grep -v "\.stories\." \| grep -v "logger.ts"` | No matches                                                |
| **SC-004** | Zero `as any` in services           | `grep -r "as any" src/services/ --include="*.ts"`                                                                                                                    | No matches                                                |
| **SC-005** | All catch blocks proper             | Manual code review + grep for empty catch                                                                                                                            | All catch blocks log with context or return ServiceResult |
| **SC-006** | Logger 100% test coverage           | `docker compose exec scripthammer pnpm test --coverage src/lib/logger/`                                                                                              | Statements, branches, functions, lines all 100%           |
| **SC-007** | All tests pass                      | `docker compose exec scripthammer pnpm test`                                                                                                                         | Exit code 0, all tests pass                               |
| **SC-008** | TypeScript compiles                 | `docker compose exec scripthammer pnpm run type-check`                                                                                                               | Exit code 0, no errors                                    |

### Acceptance Scenario Testability

| User Story | Scenario                   | Independent Test Method                                                 |
| ---------- | -------------------------- | ----------------------------------------------------------------------- |
| US1.1      | CSP no unsafe-eval         | Browser DevTools → Network → Response Headers → Content-Security-Policy |
| US1.2      | No secrets in bundle       | `grep` search in `out/` directory post-build                            |
| US1.3      | App works without eval     | Manual: Load app, verify all features functional                        |
| US2.1      | Production log suppression | Set `NODE_ENV=production`, verify only error logs appear                |
| US2.2      | Development log format     | Set `NODE_ENV=development`, verify timestamps and categories            |
| US2.3      | No direct console usage    | Automated: `grep` + ESLint rule                                         |
| US3.1      | No `as any` in services    | Automated: `grep` search                                                |
| US3.2      | Typed Supabase queries     | TypeScript compiler (`pnpm type-check`)                                 |
| US3.3      | External API validation    | Unit tests for Zod schemas                                              |
| US4.1      | Error logging with context | Unit tests asserting logger.error called with context                   |
| US4.2      | ServiceResult returns      | Unit tests for service functions                                        |
| US4.3      | User-friendly messages     | Manual: Trigger errors, verify toast/alert text                         |

---

## Non-Functional Requirements

### Performance

- **NFR-001**: Logger overhead MUST be <1ms per log call (measured via performance.now())
- **NFR-002**: Logger addition MUST NOT increase bundle size by more than 2KB gzipped
- **NFR-003**: Logger MUST be tree-shakeable in production builds (unused levels stripped)

### Security

- **NFR-004**: Logger MUST NOT output PII (emails, phone numbers, passwords, tokens) even if passed in context
- **NFR-005**: CSP changes MUST be validated against OWASP XSS attack vectors
- **NFR-006**: Build process SHOULD include secret scanning (future CI/CD enhancement)

### Maintainability

- **NFR-007**: Logger API MUST remain stable (no breaking changes without major version bump)
- **NFR-008**: Type definitions MUST be co-located with their usage (messaging types near messaging services)
- **NFR-009**: New patterns (logger, ServiceResult) MUST be documented in quickstart.md

### Testability

- **NFR-010**: Logger MUST be mockable via `vi.mock('@/lib/logger')` pattern
- **NFR-011**: ServiceResult helpers (`success`, `failure`, `isSuccess`, `isFailure`) MUST be exported for test assertions
- **NFR-012**: Test files (`*.test.ts`, `*.test.tsx`) MAY use `as any` assertions when mocking; production code MUST NOT

---

## Dependencies & Assumptions

### Dependencies

| Dependency | Purpose                                 | Version        |
| ---------- | --------------------------------------- | -------------- |
| Vitest     | Test runner and coverage                | ^2.0.0         |
| TypeScript | Type checking                           | ^5.0.0         |
| grep       | SC-003, SC-004 verification             | System default |
| ESLint     | Code quality (optional no-console rule) | ^8.0.0         |

### Validated Assumptions

| Assumption                                     | Validation                         | Reference             |
| ---------------------------------------------- | ---------------------------------- | --------------------- |
| Google Analytics/GTM works without unsafe-eval | ✅ Verified - uses standard gtag() | research.md §Topic 1  |
| Non-NEXT*PUBLIC* vars not bundled              | ✅ Verified - Next.js behavior     | research.md §Topic 4  |
| Existing test mocking uses vi.mock             | ✅ Verified - project uses Vitest  | src/test/setup.ts     |
| Monolithic Supabase migration pattern          | ✅ Per CLAUDE.md                   | CLAUDE.md §Migrations |

---

## Edge Case Specifications

### Logger Edge Cases

| Edge Case                     | Behavior                         | Test                                    |
| ----------------------------- | -------------------------------- | --------------------------------------- |
| Empty category                | Default to `'app'`               | `createLogger('') → category === 'app'` |
| Invalid category (symbols)    | Sanitize to alphanumeric+hyphen  | `createLogger('foo@bar') → 'foo-bar'`   |
| Circular reference in context | Serialize as `[Circular]`        | Pass object with self-reference         |
| Context with PII              | Log warning, redact value        | Pass `{ password: 'secret' }`           |
| Message >10KB                 | Truncate with `...[truncated]`   | Pass 20KB string                        |
| Console unavailable           | No-op, no throw                  | Mock `console` as undefined             |
| Concurrent calls              | Thread-safe (JS single-threaded) | N/A in browser                          |

### ServiceResult Edge Cases

| Edge Case            | Behavior                          | Test                                                     |
| -------------------- | --------------------------------- | -------------------------------------------------------- |
| Empty error message  | Create Error with default message | `failure('') → error.message === 'Unknown error'`        |
| Null data success    | Valid success result              | `success(null) → { data: null, error: null }` ❌ INVALID |
| Empty array success  | Valid success result              | `success([]) → { data: [], error: null }` ✅             |
| Nested ServiceResult | Not supported, flatten            | Document anti-pattern                                    |

### Type Safety Edge Cases

| Edge Case                  | Behavior                                | Test                                  |
| -------------------------- | --------------------------------------- | ------------------------------------- |
| Supabase returns null      | Type as `T \| null`                     | Query non-existent row                |
| Supabase returns undefined | Treat as error                          | Should not happen with proper queries |
| External API invalid shape | Zod parse failure → ServiceResult error | Pass malformed JSON                   |
| Optional fields missing    | Default to undefined                    | Type with `?` modifier                |

### Error Handling Edge Cases

| Edge Case                                   | Behavior                                   | Test                              |
| ------------------------------------------- | ------------------------------------------ | --------------------------------- |
| Error propagation across service boundaries | Return ServiceResult, don't rethrow        | Unit test service calling service |
| Async errors in useEffect                   | Wrap in try-catch, log, update error state | Integration test                  |
| Missing env var at startup                  | Log warning, continue with fallback        | `process.env.X === undefined`     |
| Partial migration failure                   | N/A - no DB migrations in this feature     | -                                 |
| Types don't match runtime data              | Zod validation fails, return error         | Unit test with bad data           |

---

## Traceability Matrix

### FR → SC Mapping

| Functional Requirement        | Success Criteria | User Story |
| ----------------------------- | ---------------- | ---------- |
| FR-001 (No unsafe-eval)       | SC-001           | US1        |
| FR-002 (No secrets)           | SC-002           | US1        |
| FR-003 (Logger service)       | SC-006           | US2        |
| FR-004 (No console.log)       | SC-003           | US2        |
| FR-005 (No as any)            | SC-004           | US3        |
| FR-006 (Typed queries)        | SC-008           | US3        |
| FR-007 (Error messages)       | SC-005           | US4        |
| FR-008 (Error context)        | SC-005           | US4        |
| FR-009 (Prod log suppression) | SC-007           | US2        |
| FR-010 (Dev timestamps)       | SC-007           | US2        |
| FR-011 (5-file pattern)       | SC-006           | US2        |
| FR-012 (Edge cases)           | SC-006           | US2        |
| FR-013 (No PII logging)       | SC-005           | US2, US4   |
| FR-014 (Messaging types)      | SC-008           | US3        |
| FR-015 (ServiceResult)        | SC-005           | US4        |
| FR-016 (User messages)        | SC-005           | US4        |

### Research → Decision Traceability

| Research Topic     | Decision                   | Implementation Task |
| ------------------ | -------------------------- | ------------------- |
| CSP unsafe-eval    | Remove - not needed        | T012                |
| Supabase typing    | Manual extension           | T024, T025          |
| Silent catch audit | 11 fixes identified        | T031-T035           |
| Private env vars   | False positive - no action | T014 (docs only)    |
| Logger mocking     | Export instance + helper   | T002                |
