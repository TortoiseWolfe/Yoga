# Implementation Plan: Unified Messaging Sidebar

**Branch**: `037-unified-messaging-sidebar` | **Date**: 2025-11-26 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/037-unified-messaging-sidebar/spec.md`

## Summary

Consolidate three separate messaging pages (`/messages`, `/messages/connections`, `/conversations`) into a unified experience with a tabbed sidebar. Create an `UnifiedSidebar` component with tabs for Chats, Connections, and Find People. Add a "Message" button to accepted connections and implement `getOrCreateConversation()` service method.

## Technical Context

**Language/Version**: TypeScript 5.9.2, React 19, Next.js 15.5
**Primary Dependencies**: DaisyUI (tabs, drawer), Supabase client
**Storage**: Supabase PostgreSQL (existing tables - no schema changes)
**Testing**: Vitest (unit), Pa11y (a11y), Playwright (E2E)
**Target Platform**: Web (PWA), responsive mobile-first
**Project Type**: Web application (Next.js App Router)
**Performance Goals**: Tab switching < 200ms, 60fps animations
**Constraints**: 44px minimum touch targets, WCAG AA compliance
**Scale/Scope**: Single-page refactor, 1 new component, 4 file modifications

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

| Principle                         | Status  | Notes                                  |
| --------------------------------- | ------- | -------------------------------------- |
| I. Component Structure Compliance | ✅ Pass | UnifiedSidebar will use 5-file pattern |
| II. Test-First Development        | ✅ Pass | Tests planned before implementation    |
| III. PRP Methodology              | ✅ Pass | Using SpecKit workflow                 |
| IV. Docker-First Development      | ✅ Pass | All commands via docker compose exec   |
| V. Progressive Enhancement        | ✅ Pass | Mobile drawer pattern, offline-capable |
| VI. Privacy & Compliance First    | ✅ Pass | No new data collection                 |

## Project Structure

### Documentation (this feature)

```
specs/037-unified-messaging-sidebar/
├── plan.md              # This file
├── research.md          # Existing component analysis
├── data-model.md        # Component structure and types
├── quickstart.md        # Implementation guide
└── tasks.md             # Generated by /tasks command
```

### Source Code (repository root)

```
src/
├── app/
│   ├── messages/
│   │   ├── page.tsx              # MODIFY: Use UnifiedSidebar, add tab state
│   │   └── connections/
│   │       └── page.tsx          # MODIFY: Redirect to /messages?tab=connections
│   └── conversations/
│       └── page.tsx              # MODIFY: Redirect to /messages?tab=chats
│
├── components/
│   ├── organisms/
│   │   ├── UnifiedSidebar/       # NEW: 5-file component
│   │   │   ├── index.tsx
│   │   │   ├── UnifiedSidebar.tsx
│   │   │   ├── UnifiedSidebar.test.tsx
│   │   │   ├── UnifiedSidebar.stories.tsx
│   │   │   └── UnifiedSidebar.accessibility.test.tsx
│   │   ├── ConnectionManager/
│   │   │   └── ConnectionManager.tsx  # MODIFY: Add onMessage prop
│   │   └── ConversationList/          # REUSE: No changes
│   └── molecular/
│       └── UserSearch/                # REUSE: No changes
│
├── services/
│   └── messaging/
│       └── connection-service.ts      # MODIFY: Add getOrCreateConversation()
│
├── types/
│   └── messaging.ts                   # MODIFY: Add SidebarTab type
│
└── GlobalNav.tsx                      # MODIFY: Update nav links
```

**Structure Decision**: Web application using Next.js App Router with component-based architecture. All changes confined to src/ directory. New UnifiedSidebar component follows existing atomic design pattern (organisms/).

## Implementation Phases

### Phase 1: Core Service (P1 - Enables "Message" button)

| Task | File                  | Description                            |
| ---- | --------------------- | -------------------------------------- |
| T1.1 | connection-service.ts | Add `getOrCreateConversation()` method |
| T1.2 | connection-service.ts | Add unit tests for new method          |
| T1.3 | messaging.ts          | Add `SidebarTab` type definition       |

### Phase 2: Message Button (P1 - Core UX fix)

| Task | File                       | Description                                   |
| ---- | -------------------------- | --------------------------------------------- |
| T2.1 | ConnectionManager.tsx      | Add `onMessage` prop to interface             |
| T2.2 | ConnectionManager.tsx      | Add "Message" button for accepted connections |
| T2.3 | ConnectionManager.test.tsx | Update tests for new prop                     |

### Phase 3: UnifiedSidebar Component (P2 - Unified navigation)

| Task | File                                  | Description                                    |
| ---- | ------------------------------------- | ---------------------------------------------- |
| T3.1 | UnifiedSidebar/                       | Generate component skeleton                    |
| T3.2 | UnifiedSidebar.tsx                    | Implement tab navigation and content rendering |
| T3.3 | UnifiedSidebar.test.tsx               | Write unit tests                               |
| T3.4 | UnifiedSidebar.stories.tsx            | Create Storybook stories                       |
| T3.5 | UnifiedSidebar.accessibility.test.tsx | Pa11y/axe tests                                |

### Phase 4: Page Integration (P2 - Wire everything together)

| Task | File              | Description                                  |
| ---- | ----------------- | -------------------------------------------- |
| T4.1 | messages/page.tsx | Add URL-based tab state management           |
| T4.2 | messages/page.tsx | Replace ConversationList with UnifiedSidebar |
| T4.3 | messages/page.tsx | Implement mobile drawer pattern              |

### Phase 5: Redirects and Navigation (P4 - Cleanup)

| Task | File                          | Description                           |
| ---- | ----------------------------- | ------------------------------------- |
| T5.1 | conversations/page.tsx        | Redirect to /messages?tab=chats       |
| T5.2 | messages/connections/page.tsx | Redirect to /messages?tab=connections |
| T5.3 | GlobalNav.tsx                 | Update navigation links               |

### Phase 6: Polish and Testing (All priorities)

| Task | File | Description                 |
| ---- | ---- | --------------------------- |
| T6.1 | All  | Run full test suite         |
| T6.2 | All  | Type check and lint         |
| T6.3 | All  | Verify all success criteria |

## Dependencies Between Phases

```
Phase 1 ─► Phase 2 (getOrCreateConversation needed for Message button)
          │
          ▼
Phase 2 ─► Phase 3 (ConnectionManager changes needed in sidebar)
          │
          ▼
Phase 3 ─► Phase 4 (UnifiedSidebar needed for page integration)
          │
          ▼
Phase 4 ─► Phase 5 (Page must work before adding redirects)
          │
          ▼
Phase 5 ─► Phase 6 (All features must be complete before final testing)
```

## Risk Mitigation

| Risk                                    | Mitigation                                 |
| --------------------------------------- | ------------------------------------------ |
| Breaking existing messaging             | Comprehensive test coverage before changes |
| Race condition in conversation creation | Database UNIQUE constraint + retry logic   |
| Tab state conflicts                     | URL as single source of truth              |
| Mobile UX issues                        | Test on multiple viewport sizes            |

## Complexity Tracking

_No constitution violations - standard implementation within existing patterns._

## Progress Tracking

| Phase                     | Status      | Notes                                  |
| ------------------------- | ----------- | -------------------------------------- |
| Phase 0: Research         | ✅ Complete | See research.md                        |
| Phase 1: Core Service     | ✅ Complete | getOrCreateConversation implemented    |
| Phase 2: Message Button   | ✅ Complete | ConnectionManager onMessage prop added |
| Phase 3: UnifiedSidebar   | ✅ Complete | 5-file component with tabs             |
| Phase 4: Page Integration | ✅ Complete | Mobile drawer pattern                  |
| Phase 5: Redirects        | ✅ Complete | Legacy routes redirect                 |
| Phase 6: Polish           | ✅ Complete | Tests pass, type-check pass, lint pass |

**Implementation Status**: All automated tasks complete. Manual verification tasks (T023-T025) remain for user to perform in browser.
