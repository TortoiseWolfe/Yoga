# Implementation Plan: Fix Conversations Page Infinite Loading Spinner

**Branch**: `029-fix-conversations-page` | **Date**: 2025-11-25 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/029-fix-conversations-page/spec.md`

## Summary

Fix the conversations page infinite loading spinner by first diagnosing the root cause with console.logs, then implementing appropriate fixes (timeout, error handling, state management). The page must always resolve to content, empty state, or error - never infinite spinner.

## Technical Context

**Language/Version**: TypeScript 5.x, React 19, Next.js 15.5+
**Primary Dependencies**: @supabase/supabase-js, React hooks (useState, useEffect, useCallback)
**Storage**: Supabase (PostgreSQL) via client SDK
**Testing**: Vitest (unit), Playwright (E2E)
**Target Platform**: Web (static export), all modern browsers
**Project Type**: Web application (Next.js App Router)
**Performance Goals**: Page content within 5 seconds, query timeout at 10 seconds
**Constraints**: Must work with existing auth context, no infinite spinner states
**Scale/Scope**: Single page fix, existing codebase

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

| Principle                    | Status  | Notes                                                       |
| ---------------------------- | ------- | ----------------------------------------------------------- |
| I. Component Structure       | ✅ PASS | Modifying existing page, not creating component             |
| II. Test-First Development   | ✅ PASS | Will add diagnostic logging first, then tests               |
| III. PRP Methodology         | ✅ PASS | Following /specify → /clarify → /plan → /tasks → /implement |
| IV. Docker-First Development | ✅ PASS | All development in Docker                                   |
| V. Progressive Enhancement   | ✅ PASS | Error states, retry capability                              |
| VI. Privacy & Compliance     | ✅ PASS | No new data collection                                      |

## Project Structure

### Documentation (this feature)

```
specs/029-fix-conversations-page/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 research findings
├── data-model.md        # State management model
├── quickstart.md        # Integration guide
└── tasks.md             # Generated by /tasks command
```

### Source Code (files to modify)

```
src/
└── app/
    └── conversations/
        └── page.tsx             # PRIMARY: Add logging, timeout, fix loading state

tests/
└── e2e/
    └── conversations/
        └── loading.spec.ts      # E2E test for loading behavior
```

**Structure Decision**: Single file modification - existing conversations page at `src/app/conversations/page.tsx`

## Phase 0: Research Findings

### Root Cause Investigation Plan

The clarification established we need to debug first. Key areas to investigate:

1. **Auth Context State**: Is `authLoading` completing? Is `user` populated?
2. **useEffect Trigger**: Is `loadConversations` being called?
3. **Supabase Query**: Is the query executing? Hanging? Returning error?
4. **State Updates**: Is `setLoading(false)` being reached?

### Diagnostic Logging Strategy

Add console.logs at these checkpoints:

- Component mount
- Auth state changes (authLoading, user)
- useEffect trigger conditions
- loadConversations entry/exit
- Supabase query start/complete/error
- Each setLoading call

## Phase 1: Design

### Loading State Flow

```
Page Mount
    ↓
authLoading=true, loading=true → Show spinner
    ↓
Auth completes (authLoading=false)
    ↓
[user exists?]
    ├── No → setLoading(false), show "Please sign in"
    └── Yes → loadConversations()
              ↓
         [Query completes?]
              ├── Success → setConversations, setLoading(false) → Show list/empty
              ├── Error → setError, setLoading(false) → Show error
              └── Timeout (10s) → setError("Timeout"), setLoading(false) → Show error
```

### Fix Strategy

1. **Add comprehensive logging** (FR-001, FR-007)
2. **Add query timeout** (FR-003) - wrap Supabase query with Promise.race
3. **Ensure all code paths set loading=false** (FR-006)
4. **Add retry functionality** (FR-005)

## Complexity Tracking

_No constitution violations - this is a bug fix with minimal new code._

## Progress Tracking

| Phase             | Status      | Artifacts                    |
| ----------------- | ----------- | ---------------------------- |
| Phase 0: Research | ✅ Complete | research.md                  |
| Phase 1: Design   | ✅ Complete | data-model.md, quickstart.md |
| Phase 2: Tasks    | ⏳ Pending  | tasks.md                     |
| Implementation    | ⏳ Pending  | Code changes                 |
