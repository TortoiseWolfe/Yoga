# Implementation Plan: Fix Auth System Failures

**Branch**: `028-fix-auth-system` | **Date**: 2025-11-24 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/028-fix-auth-system/spec.md`

## Summary

Fix three critical auth failures: intermittent sign-in (button clicks do nothing), broken sign-out (can't sign out), and conversations page infinite spinner. Root cause is `supabase.auth.getSession()` not completing, causing AuthContext 5-second timeout cascade. Solution: add proper error handling, retry logic with exponential backoff, fail-safe sign-out, and cross-tab auth state synchronization.

## Technical Context

**Language/Version**: TypeScript 5.x, React 19, Next.js 15.5+
**Primary Dependencies**: @supabase/supabase-js, React Context API, DaisyUI
**Storage**: Supabase (PostgreSQL), localStorage (session)
**Testing**: Vitest (unit), Playwright (E2E)
**Target Platform**: Web (static export), all modern browsers
**Project Type**: Web application (Next.js App Router)
**Performance Goals**: Auth operations complete within 5 seconds, sign-in/out within 3 seconds
**Constraints**: Offline-capable fail-safe logout, cross-tab session sync
**Scale/Scope**: Existing production app, 4 files to modify

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

| Principle                    | Status  | Notes                                                    |
| ---------------------------- | ------- | -------------------------------------------------------- |
| I. Component Structure       | ✅ PASS | No new components needed, modifying existing AuthContext |
| II. Test-First Development   | ✅ PASS | Will write tests before implementation                   |
| III. PRP Methodology         | ✅ PASS | Following /specify → /plan → /tasks → /implement         |
| IV. Docker-First Development | ✅ PASS | All development in Docker                                |
| V. Progressive Enhancement   | ✅ PASS | Fail-safe logout works offline                           |
| VI. Privacy & Compliance     | ✅ PASS | No new data collection                                   |

## Project Structure

### Documentation (this feature)

```
specs/028-fix-auth-system/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 research findings
├── data-model.md        # Updated auth state model
├── quickstart.md        # Integration guide
└── tasks.md             # Generated by /tasks command
```

### Source Code (files to modify)

```
src/
├── contexts/
│   └── AuthContext.tsx          # Primary: add error state, retry logic, fail-safe signOut
├── lib/
│   ├── supabase/
│   │   └── client.ts            # No changes needed - error propagation already correct
│   └── auth/
│       └── retry-utils.ts       # NEW: exponential backoff utility
├── components/
│   └── auth/
│       └── SignInForm/
│           └── SignInForm.tsx   # Minor: handle checkRateLimit errors
└── app/
    └── conversations/
        └── page.tsx             # Minor: handle auth timeout error state

tests/
├── unit/
│   └── auth/
│       └── AuthContext.test.tsx # Unit tests for retry logic
└── e2e/
    └── auth/
        └── sign-in-out.spec.ts  # E2E tests for auth flows
```

**Structure Decision**: Single web application - modifying existing files, adding one utility file for retry logic.

## Phase 0: Research Findings

See [research.md](./research.md) for detailed analysis.

**Key Findings**:

1. AuthContext timeout (5s) fires because `getSession()` never resolves in some scenarios
2. signOut doesn't clear local state on Supabase API failure
3. `onAuthStateChange` already exists but doesn't trigger cross-tab redirects
4. SignInForm works correctly - issue is upstream in rate limit check or auth context

## Phase 1: Design

### Architecture Changes

1. **AuthContext State Extension**:
   - Add `error: AuthError | null` to state
   - Add `retryCount: number` for tracking retry attempts
   - Add `retry()` method to context interface

2. **Retry Logic** (FR-007):
   - Exponential backoff: 1s, 2s, 4s delays
   - Max 3 automatic retries
   - Manual retry button after exhaustion

3. **Fail-Safe Sign-Out** (FR-004, FR-005):
   - Clear local state BEFORE Supabase call
   - Force page reload after sign-out
   - Catch and ignore Supabase errors

4. **Cross-Tab Sync** (FR-009):
   - Use existing `onAuthStateChange` listener
   - On `SIGNED_OUT` event, redirect to home
   - Use `window.location.href` for hard redirect

### Data Flow

```
User Action → AuthContext → Supabase API
                ↓
         [Success] → Update state → Notify subscribers
                ↓
         [Failure] → Retry (up to 3x) → Show error → Manual retry option
                ↓
         [Timeout] → Force loading=false → Show error with retry
```

## Complexity Tracking

_No constitution violations - this is a bug fix with minimal new code._

## Progress Tracking

| Phase             | Status      | Artifacts                    |
| ----------------- | ----------- | ---------------------------- |
| Phase 0: Research | ✅ Complete | research.md                  |
| Phase 1: Design   | ✅ Complete | data-model.md, quickstart.md |
| Phase 2: Tasks    | ✅ Complete | tasks.md                     |
| Implementation    | ⏳ Pending  | Code changes                 |
