# Implementation Plan: Fix Messaging Layout

**Branch**: `007-fix-messaging-layout` | **Date**: 2025-11-29 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/007-fix-messaging-layout/spec.md`

## Summary

Fix critical CSS layout issues preventing message scroll and clipping input box. Replace nested flexbox with CSS Grid `grid-rows-[auto_1fr_auto]` pattern for single scroll container. Message list is the ONLY scrollable element - header and input are fixed.

## Technical Context

**Language/Version**: TypeScript 5.9, React 19, Next.js 15.5
**Primary Dependencies**: Tailwind CSS 4, DaisyUI
**Storage**: N/A (CSS-only fix)
**Testing**: Manual browser testing + existing Vitest/Playwright tests
**Target Platform**: Web (Chrome, Firefox, Safari, mobile browsers)
**Project Type**: Web application (Next.js)
**Performance Goals**: Scroll appears within 1 second of page load
**Constraints**: Must work on mobile viewports (375px+), no nested scroll containers
**Scale/Scope**: 4 files modified, ~50 lines changed

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

| Principle                    | Status | Notes                                                                                                |
| ---------------------------- | ------ | ---------------------------------------------------------------------------------------------------- |
| I. Component Structure       | PASS   | Modifying existing components, no new components                                                     |
| II. Test-First Development   | PASS   | Manual testing justified: CSS-only fix, no logic changes, existing component tests cover regressions |
| III. PRP Methodology         | PASS   | Using /specify → /plan → /tasks flow                                                                 |
| IV. Docker-First Development | PASS   | All testing in Docker                                                                                |
| V. Progressive Enhancement   | PASS   | CSS Grid with fallback behavior                                                                      |
| VI. Privacy & Compliance     | N/A    | No data changes                                                                                      |

## Project Structure

### Documentation (this feature)

```
specs/007-fix-messaging-layout/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Root cause analysis (Phase 0)
└── tasks.md             # Implementation tasks (Phase 2 - /tasks command)
```

### Source Code (files to modify)

```
src/
├── app/
│   └── messages/
│       └── page.tsx                    # Remove wrapper div at line 416
├── components/
│   ├── organisms/
│   │   └── ChatWindow/
│   │       └── ChatWindow.tsx          # CSS Grid layout
│   ├── molecular/
│   │   └── MessageThread/
│   │       └── MessageThread.tsx       # Scroll container fixes
│   └── atomic/
│       └── MessageBubble/
│           └── MessageBubble.tsx       # Decryption error display
```

**Structure Decision**: Next.js App Router with atomic design component hierarchy. All changes are CSS/layout modifications to existing components.

## Complexity Tracking

_No complexity violations - this is a focused CSS fix._

## Implementation Phases

### Phase 0: Research (Complete)

Root cause identified in spec.md:

- 6+ nested h-full flex containers
- Height doesn't propagate reliably
- Solution: CSS Grid `grid-rows-[auto_1fr_auto]`

### Phase 1: Design

**ChatWindow Layout (CSS Grid)**:

```tsx
<div className="grid h-full grid-rows-[auto_1fr_auto]">
  <header className="border-b">...</header>
  <div className="min-h-0 overflow-y-auto">
    <MessageThread />
  </div>
  <div className="border-t">
    <MessageInput />
  </div>
</div>
```

**page.tsx Simplification**:

- Remove wrapper div at line 416
- Pass `className="h-full"` directly to ChatWindow

**MessageThread**:

- Ensure scroll container has `overflow-y-auto`
- Keep jump button with `absolute` positioning within scroll container

### Phase 2: Tasks

Tasks will be generated by `/tasks` command:

1. Fix ChatWindow.tsx - CSS Grid layout
2. Fix page.tsx - Remove wrapper div
3. Fix MessageThread.tsx - Scroll container
4. Fix MessageBubble.tsx - Decryption error display
5. Manual testing with 30 messages

## Success Criteria Verification

| Criterion                              | How to Verify                                   |
| -------------------------------------- | ----------------------------------------------- |
| SC-001: Scroll works with 30 messages  | `pnpm run db:reset`, login, view messages       |
| SC-002: Input visible on all viewports | Browser DevTools responsive mode                |
| SC-003: Jump button works              | Scroll up 500px, click button                   |
| SC-004: Decryption errors friendly     | View test messages (placeholder encrypted)      |
| SC-005: Cross-browser                  | Test Chrome, Firefox, Safari (or iOS emulation) |
