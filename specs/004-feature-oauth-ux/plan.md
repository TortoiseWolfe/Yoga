# Implementation Plan: OAuth UX Polish

**Branch**: `004-feature-oauth-ux` | **Date**: 2025-11-28 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-feature-oauth-ux/spec.md`

## Summary

Fix two UX issues discovered during OAuth/messaging testing:

1. **OAuth Display Name**: Extract display_name from OAuth provider metadata (full_name > name > email prefix > "Anonymous User") and populate user_profiles on first sign-in
2. **Message Scroll**: Add missing `h-full` class to drawer-content div to fix scroll container height calculation

Technical approach: Extend existing `oauth-utils.ts` with extraction functions, update OAuth callback to populate profile, and fix CSS class in messages page.

## Technical Context

**Language/Version**: TypeScript 5.x, React 19, Next.js 15
**Primary Dependencies**: Supabase Auth, DaisyUI, Tailwind CSS 4
**Storage**: PostgreSQL via Supabase (user_profiles table)
**Testing**: Vitest (unit), Playwright (E2E)
**Target Platform**: Web (PWA), responsive mobile-first
**Project Type**: Web application (Next.js App Router)
**Performance Goals**: N/A (single-user operations)
**Constraints**: Docker-first development, 5-file component pattern
**Scale/Scope**: Individual user profile operations

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

| Principle                  | Status | Notes                                    |
| -------------------------- | ------ | ---------------------------------------- |
| I. Component Structure     | N/A    | No new components created                |
| II. Test-First Development | ✅     | Unit tests for new oauth-utils functions |
| III. PRP Methodology       | ✅     | Using SpecKit workflow                   |
| IV. Docker-First           | ✅     | All commands via docker compose exec     |
| V. Progressive Enhancement | ✅     | Fallback cascade for missing metadata    |
| VI. Privacy & Compliance   | ✅     | Only using provider-provided metadata    |

## Project Structure

### Documentation (this feature)

```
specs/004-feature-oauth-ux/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Codebase analysis
├── data-model.md        # Schema documentation
├── quickstart.md        # Implementation guide
├── contracts/           # Function contracts
│   ├── oauth-utils.contract.md
│   ├── auth-callback.contract.md
│   └── messages-page.contract.md
└── tasks.md             # Generated by /tasks
```

### Source Code (files to modify)

```
src/
├── lib/
│   └── auth/
│       ├── oauth-utils.ts           # Add extraction functions
│       └── oauth-utils.test.ts      # Add unit tests
├── app/
│   ├── auth/
│   │   └── callback/
│   │       └── page.tsx             # Add profile population
│   └── messages/
│       └── page.tsx                 # Add h-full class (line 290)

supabase/
└── migrations/
    └── 20251006_complete_monolithic_setup.sql  # Add migration query
```

**Structure Decision**: Existing web application structure. No new files created except tests. Modifications to 4 existing files.

## Complexity Tracking

No constitutional violations. This is a straightforward bugfix feature.

## Implementation Phases

### Phase 1: OAuth Utilities (P1 - Display Name)

1. Add `extractOAuthDisplayName(user)` to oauth-utils.ts
2. Add `extractOAuthAvatarUrl(user)` to oauth-utils.ts
3. Add `populateOAuthProfile(user)` to oauth-utils.ts
4. Write unit tests for all three functions

### Phase 2: Auth Callback Integration

1. Import new functions in callback/page.tsx
2. Add profile population after user authentication
3. Add error handling (non-blocking)

### Phase 3: Scroll Fix (P2)

1. Add `h-full` to drawer-content div in messages/page.tsx
2. Verify scroll works on desktop and mobile viewports

### Phase 4: Migration (P3)

1. Add UPDATE query to monolithic migration
2. Run query in Supabase SQL Editor for existing users

## Progress Tracking

| Phase              | Status      | Output                                   |
| ------------------ | ----------- | ---------------------------------------- |
| Phase 0 - Research | ✅ Complete | research.md                              |
| Phase 1 - Design   | ✅ Complete | data-model.md, contracts/, quickstart.md |
| Phase 2 - Tasks    | ✅ Complete | tasks.md                                 |

## Risk Assessment

| Risk                     | Impact | Mitigation                                 |
| ------------------------ | ------ | ------------------------------------------ |
| OAuth metadata missing   | Low    | Fallback cascade to "Anonymous User"       |
| Race with DB trigger     | Low    | Trigger creates row first, we update after |
| Scroll fix breaks layout | Low    | Adding class is additive, easy rollback    |

## Dependencies

- Existing `oauth-utils.ts` module
- Supabase `user_profiles` table (no schema changes)
- DaisyUI drawer component
